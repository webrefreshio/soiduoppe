---
// Assets
import { Image } from "astro:assets";
// Fundations
import BaseLayout from "@/layouts/BaseLayout.astro";
import Text from "@/components/fundations/elements/Text.astro";
import Button from "@/components/fundations/elements/Button.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
// Sections
import BlogCard from "@/components/blog/BlogCard.astro";
const { frontmatter } = Astro.props;

// Get all posts and filter by tag
import { getCollection } from "astro:content";
const allPosts = await getCollection("posts");
const relatedPosts = allPosts.filter((post) =>
  post.data.tags.some((tag) => frontmatter.tags.includes(tag))
);
const filteredRelatedPosts = relatedPosts
  .filter((post) => post.data.title !== frontmatter.title)
  .slice(0, 2);
const publishedDate = new Date(frontmatter.pubDate);
const formattedPubDate = publishedDate.toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "2-digit",
});
const tags = (frontmatter.tags ?? []).map((tag) => {
  const raw = (tag ?? "").toString().trim();
  const slugSource = raw
    .toLowerCase()
    .replace(/^#+/, "")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "");
  const slug = encodeURIComponent(slugSource || "tag");
  const label =
    raw.replace(/^#+/, "").replace(/[-_]+/g, " ").replace(/\s+/g, " ").trim() ||
    "Tag";
  return { label, slug };
});
---

<BaseLayout>
  <section class="bg-gradient-to-t from-base-200 to-white overflow-hidden">
    <Wrapper variant="standard" class="pt-24 lg:pt-32">
      <div class="max-w-3xl mx-auto text-center">
        <Text
          tag="span"
          variant="textSM"
          class="pl-4 font-medium uppercase border-l text-base-900 font-display border-accent-500"
        >
          {tags[0]?.label ?? "Automotive Insights"}
        </Text>
        <Text
          tag="h1"
          variant="displayMD"
          class="mt-8 uppercase font-display text-base-900"
        >
          {frontmatter.title}
        </Text>
        <Text
          tag="p"
          variant="textBase"
          class="mt-4 text-base-600 text-balance"
        >
          {frontmatter.description}
        </Text>
      </div>
      <Image
        width={1920}
        height={1080}
        src={frontmatter.image.url}
        alt={frontmatter.image.alt}
        class="size-full object-cover object-center rounded-t-3xl aspect-4/2 shadow-2xl outline-4 outline-base-500/10 mt-12"
      />
    </Wrapper>
  </section>
  <section>
    <Wrapper variant="standard" class="py-12">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
        <div class="lg:col-span-2">
          <div class="relative pl-4 border-l-2 border-accent-500">
            <Text
              tag="h2"
              variant="textLG"
              class="text-base-900 font-bold uppercase tracking-wide"
            >
              In this article
            </Text>
            <Text
              tag="p"
              variant="textBase"
              class="text-base-500 max-w-2xl mt-4 text-balance"
            >
              {frontmatter.description}
            </Text>
          </div>
          <Wrapper variant="prose" class="mt-8">
            <slot />
          </Wrapper>
        </div>
        <div>
          <aside class="lg:sticky lg:top-32">
            <div
              class="flex flex-col bg-white rounded-3xl shadow-2xl outline-4 outline-base-500/10 divide-y divide-base-500/10"
            >
              <div class="p-6">
                <Text
                  tag="h3"
                  variant="textLG"
                  class="font-medium font-display text-base-900 uppercase"
                >
                  Published
                  <time class="ml-1" datetime={publishedDate.toISOString()}>
                    {formattedPubDate}
                  </time>
                </Text>
                <ul role="list" class="flex flex-col gap-1 mt-4">
                  {
                    tags.map(({ label, slug }) => (
                      <a
                        href={`/blog/tags/${slug}`}
                        class="text-base-900 capitalize text-sm hover:text-accent-500 underline-offset-4 hover:underline flex"
                      >
                        {label}
                      </a>
                    ))
                  }
                </ul>
              </div>
              <div class="p-6">
                <Text
                  tag="h3"
                  variant="textLG"
                  class="font-medium font-display text-base-900 uppercase"
                >
                  Explore more topics
                </Text>
                <Text tag="p" variant="textSM" class="mt-2 text-base-500">
                  Discover more insights and maintenance tips.
                </Text>
                <Button
                  isLink
                  href="/blog"
                  variant="default"
                  size="xs"
                  class="mt-12 w-fit"
                >
                  View all articles
                </Button>
              </div>
            </div>
          </aside>
        </div>
      </div>
    </Wrapper>
  </section>
  {
    filteredRelatedPosts.length > 0 && (
      <section class="bg-gradient-to-b from-base-200 to-white">
        <Wrapper variant="standard" class="py-12 lg:py-24">
          <div class="grid grid-cols-1 lg:grid-cols-3 lg:items-end">
            <div class="lg:col-span-2">
              <Text
                tag="h2"
                variant="displayXL"
                class="font-display text-base-900 uppercase mt-8"
              >
                Related articles
              </Text>
              <Text tag="p" variant="textBase" class="text-base-500 mt-2">
                Keep learning with more stories from our team.
              </Text>
            </div>
            <Button
              isLink
              href="/blog"
              variant="muted"
              size="sm"
              class="w-fit lg:mt-auto lg:ml-auto"
            >
              View all posts
            </Button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-12">
            {filteredRelatedPosts.map((post) => (
              <BlogCard post={post} />
            ))}
          </div>
        </Wrapper>
      </section>
    )
  }
</BaseLayout>
